<script>
import CodeBlock from "@/components/util/Code-Block.vue";

export default {
  name: "giteeCode",
  props: {},
  components: {CodeBlock},
  methods: {},
  data() {
    return {
      code: "package cloud.xuxiaowei.passport.configuration;\n\nimport cloud.xuxiaowei.core.properties.CloudClientProperties;\nimport cloud.xuxiaowei.core.properties.CloudJwkKeyProperties;\nimport cloud.xuxiaowei.passport.handler.AccessTokenAuthenticationFailureHandlerImpl;\nimport cloud.xuxiaowei.passport.service.impl.ClientPasswordEncoder;\nimport com.nimbusds.jose.jwk.JWKSet;\nimport com.nimbusds.jose.jwk.RSAKey;\nimport com.nimbusds.jose.jwk.source.ImmutableJWKSet;\nimport com.nimbusds.jose.jwk.source.JWKSource;\nimport com.nimbusds.jose.proc.SecurityContext;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.annotation.Order;\nimport org.springframework.security.authentication.AnonymousAuthenticationProvider;\nimport org.springframework.security.authentication.AuthenticationProvider;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.oauth2.jwt.JwtDecoder;\nimport org.springframework.security.oauth2.server.authorization.OAuth2AuthorizationService;\nimport org.springframework.security.oauth2.server.authorization.authentication.*;\nimport org.springframework.security.oauth2.server.authorization.client.RegisteredClientRepository;\nimport org.springframework.security.oauth2.server.authorization.config.annotation.web.configuration.OAuth2AuthorizationServerConfiguration;\nimport org.springframework.security.oauth2.server.authorization.config.annotation.web.configurers.OAuth2AuthorizationServerConfigurer;\nimport org.springframework.security.oauth2.server.authorization.config.annotation.web.configurers.OAuth2TokenEndpointConfigurer;\nimport org.springframework.security.oauth2.server.authorization.oidc.authentication.OidcUserInfoAuthenticationProvider;\nimport org.springframework.security.oauth2.server.authorization.settings.AuthorizationServerSettings;\nimport org.springframework.security.oauth2.server.authorization.web.OAuth2AuthorizationEndpointFilter;\nimport org.springframework.security.oauth2.server.authorization.web.OAuth2TokenEndpointFilter;\nimport org.springframework.security.oauth2.server.authorization.web.authentication.*;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.AuthenticationConverter;\nimport org.springframework.security.web.authentication.AuthenticationSuccessHandler;\n\nimport java.util.Arrays;\n\n/**\n * 授权服务器配置\n *\n * @author xuxiaowei\n * @see <a href=\"http://127.0.0.1:1301/.well-known/oauth-authorization-server\">OAuth 2.0\n * 授权服务器元数据请求的默认端点URI</a>\n * @see <a href=\n * \"http://127.0.0.1:1301/oauth2/authorize?client_id=xuxiaowei_client_id&redirect_uri=http://127.0.0.1:1401/code&response_type=code&scope=snsapi_base&state=beff3dfc-bad8-40db-b25f-e5459e3d6ad7\">/oauth2/authorize</a>\n * @see <a href=\n * \"https://docs.spring.io/spring-security/reference/6.0.0-M3/servlet/oauth2/resource-server/jwt.html#oauth2resourceserver-jwt-authorization-extraction\">手动提取权限-6.0.0-M3</a>\n * @see <a href=\n * \"https://github.com/spring-projects/spring-authorization-server/issues/181#issuecomment-756913042\">将用户权限作为声明传播`Jwt`是一种自定义行为</a>\n * @see <a href=\n * \"https://github.com/spring-projects/spring-authorization-server/blob/a30a1692b28915947a001f1e2a6d1e41a550eaa7/oauth2-authorization-server/src/test/java/org/springframework/security/config/annotation/web/configurers/oauth2/server/authorization/OidcTests.java#L264\">自定义\n * Jwt 声明和标头官方示例代码</a>\n * @see <a href=\n * \"https://github.com/spring-projects/spring-authorization-server/issues/199\">自定义 Jwt\n * 声明和标头需要更灵活 议题</a>\n * @since 0.0.1\n */\n@Slf4j\n@Configuration(proxyBeanMethods = false)\npublic class AuthorizationServerConfiguration {\n\n\tprivate CloudJwkKeyProperties cloudJwkKeyProperties;\n\n\tprivate CloudClientProperties cloudClientProperties;\n\n\tprivate AuthenticationSuccessHandler authenticationSuccessHandler;\n\n\t@Autowired\n\tpublic void setCloudJwkKeyProperties(CloudJwkKeyProperties cloudJwkKeyProperties) {\n\t\tthis.cloudJwkKeyProperties = cloudJwkKeyProperties;\n\t}\n\n\t@Autowired\n\tpublic void setCloudClientProperties(CloudClientProperties cloudClientProperties) {\n\t\tthis.cloudClientProperties = cloudClientProperties;\n\t}\n\n\t@Autowired\n\t@Qualifier(\"revocationAuthenticationSuccessHandler\")\n\tpublic void setAuthenticationSuccessHandler(AuthenticationSuccessHandler authenticationSuccessHandler) {\n\t\tthis.authenticationSuccessHandler = authenticationSuccessHandler;\n\t}\n\n\t/**\n\t * @see <a href=\n\t * \"https://docs.spring.io/spring-authorization-server/docs/current/reference/html/protocol-endpoints.html\">协议端点的</a>\n\t * Spring Security 过滤器链。\n\t * @see OAuth2AuthorizationServerConfiguration#applyDefaultSecurity(HttpSecurity) 默认\n\t * OAuth 2.1 授权配置\n\t * @see OAuth2AuthorizationEndpointFilter 默认 OAuth 2.1 授权页面\n\t *\n\t * @see OAuth2TokenEndpointFilter#setAuthenticationConverter(AuthenticationConverter)\n\t * @see OAuth2TokenEndpointConfigurer#accessTokenRequestConverter(AuthenticationConverter)\n\t * @see OAuth2TokenEndpointConfigurer#authenticationProvider(AuthenticationProvider)\n\t * @see AnonymousAuthenticationProvider\n\t * @see JwtClientAssertionAuthenticationProvider\n\t * @see ClientSecretAuthenticationProvider\n\t * @see PublicClientAuthenticationProvider\n\t * @see OAuth2AuthorizationCodeRequestAuthenticationProvider\n\t * @see OAuth2AuthorizationCodeAuthenticationProvider\n\t * @see OAuth2RefreshTokenAuthenticationProvider\n\t * @see OAuth2ClientCredentialsAuthenticationProvider\n\t * @see OAuth2TokenIntrospectionAuthenticationProvider\n\t * @see OAuth2TokenRevocationAuthenticationProvider\n\t * @see OidcUserInfoAuthenticationProvider\n\t * @see HttpSecurity#authenticationProvider(AuthenticationProvider)\n\t */\n\t@Bean\n\t@Order(-1)\n\tpublic SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http,\n\t\t\tRegisteredClientRepository registeredClientRepository, OAuth2AuthorizationService authorizationService)\n\t\t\tthrows Exception {\n\n\t\tOAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http);\n\n\t\tOAuth2AuthorizationServerConfigurer authorizationServerConfigurer = http\n\t\t\t.getConfigurer(OAuth2AuthorizationServerConfigurer.class);\n\n\t\tauthorizationServerConfigurer\n\t\t\t.authorizationEndpoint(authorizationEndpointCustomizer -> authorizationEndpointCustomizer\n\t\t\t\t.consentPage(cloudClientProperties.getConsentPage()));\n\n\t\t// 自定义客户授权\n\t\t// @formatter:off\n\t\tauthorizationServerConfigurer.tokenEndpoint(tokenEndpointCustomizer -> tokenEndpointCustomizer\n\t\t\t.accessTokenRequestConverter(new DelegatingAuthenticationConverter(Arrays.asList(\n\t\t\t\t\t// 新增：支付宝小程序 登录 OAuth2 用于验证授权授予的 {@link OAuth2AlipayMiniProgramAuthenticationToken}\n\t\t\t\t\tnew OAuth2AlipayMiniProgramAuthenticationConverter(),\n\t\t\t\t\t// 新增：支付宝 登录 OAuth2 用于验证授权授予的 {@link OAuth2AlipayOplatformWebsiteAuthenticationToken}\n\t\t\t\t\tnew OAuth2AlipayOplatformWebsiteAuthenticationConverter(),\n\t\t\t\t\t// 新增：钉钉 dingtalk 登录 OAuth2 用于验证授权授予的 {@link OAuth2DingtalkAuthenticationToken}\n\t\t\t\t\tnew OAuth2DingtalkAuthenticationConverter(),\n\t\t\t\t\t// 新增：飞书网页应用 登录 OAuth2 用于验证授权授予的 {@link OAuth2FeiShuWebPageAuthenticationToken}\n\t\t\t\t\tnew OAuth2FeiShuWebPageAuthenticationConverter(),\n\t\t\t\t\t// 新增：码云 Gitee 网站应用 OAuth2 用于验证授权授予的 {@link OAuth2GiteeAuthenticationToken}\n\t\t\t\t\tnew OAuth2GiteeAuthenticationConverter(),\n\t\t\t\t\t// 新增：GitHub 登录 OAuth2 用于验证授权授予的 {@link OAuth2GitHubAuthenticationToken}\n\t\t\t\t\tnew OAuth2GitHubAuthenticationConverter(),\n\t\t\t\t\t// 新增：GitLab 网站应用 OAuth2 用于验证授权授予的 {@link OAuth2GitLabAuthenticationToken}\n\t\t\t\t\tnew OAuth2GitLabAuthenticationConverter(),\n\t\t\t\t\t// 新增：QQ小程序 登录 OAuth2 用于验证授权授予的 {@link OAuth2QQMiniProgramAuthenticationToken}\n\t\t\t\t\tnew OAuth2QQMiniProgramAuthenticationConverter(),\n\t\t\t\t\t// 新增：QQ 网站应用 OAuth2 用于验证授权授予的 {@link OAuth2QQWebsiteAuthenticationToken}\n\t\t\t\t\tnew OAuth2QQWebsiteAuthenticationConverter(),\n\t\t\t\t\t// 新增：微信小程序 OAuth2 用于验证授权授予的 {@link OAuth2WeChatMiniProgramAuthenticationToken}\n\t\t\t\t\tnew OAuth2WeChatMiniProgramAuthenticationConverter(),\n\t\t\t\t\t// 新增：微信公众号 OAuth2 用于验证授权授予的 {@link OAuth2WeChatOffiaccountAuthenticationToken}\n\t\t\t\t\tnew OAuth2WeChatOffiaccountAuthenticationConverter(),\n\t\t\t\t\t// 新增：微信开放平台 网站应用 OAuth2 用于验证授权授予的 {@link OAuth2WeChatOplatformWebsiteAuthenticationToken}\n\t\t\t\t\tnew OAuth2WeChatOplatformWebsiteAuthenticationConverter(),\n\t\t\t\t\t// 新增：企业微信扫码登录 OAuth2 用于验证授权授予的 {@link OAuth2WeChatWorkWebsiteAuthenticationToken}\n\t\t\t\t\tnew OAuth2WeChatWorkWebsiteAuthenticationConverter(),\n\t\t\t\t\t// 新增：微博 网站应用 OAuth2 用于验证授权授予的 {@link OAuth2WeiBoWebsiteAuthenticationToken}\n\t\t\t\t\tnew OAuth2WeiBoWebsiteAuthenticationConverter()\n\n\t\t\t\t\t// 默认值：OAuth2 授权码认证转换器，已存在\n\t\t\t\t\t// new OAuth2AuthorizationCodeAuthenticationConverter()\n\t\t\t\t\t// 默认值：OAuth2 刷新令牌认证转换器，已存在\n\t\t\t\t\t// new OAuth2RefreshTokenAuthenticationConverter()\n\t\t\t\t\t// 默认值：OAuth2 客户端凭据身份验证转换器，已存在\n\t\t\t\t\t// new OAuth2ClientCredentialsAuthenticationConverter()\n\t\t\t)))\n\t\t\t// 用于处理失败的身份验证尝试的策略。\n\t\t\t.errorResponseHandler(new AccessTokenAuthenticationFailureHandlerImpl()));\n\t\t// @formatter:on\n\n\t\t// 支付宝 小程序 登录 OAuth2 身份验证提供程序\n\t\tnew OAuth2AlipayMiniProgramAuthenticationProvider(http);\n\t\t// 支付宝 网站应用 登录 OAuth2 身份验证提供程序\n\t\tnew OAuth2AlipayOplatformWebsiteAuthenticationProvider(http);\n\t\t// 钉钉 dingtalk 登录 OAuth2 身份验证提供程序\n\t\tnew OAuth2DingtalkAuthenticationProvider(http);\n\t\t// 飞书网页应用 登录 OAuth2 身份验证提供程序\n\t\tnew OAuth2FeiShuWebPageAuthenticationProvider(http);\n\t\t// 码云 Gitee 网站应用 OAuth2 身份验证提供程序\n\t\tnew OAuth2GiteeAuthenticationProvider(http);\n\t\t// GitHub 登录 OAuth2 身份验证提供程序\n\t\tnew OAuth2GitHubAuthenticationProvider(http);\n\t\t// GitLab 网站应用 OAuth2 身份验证提供程序\n\t\tnew OAuth2GitLabAuthenticationProvider(http);\n\t\t// QQ 小程序 登录 OAuth2 身份验证提供程序\n\t\tnew OAuth2QQMiniProgramAuthenticationProvider(http);\n\t\t// QQ 网站应用 OAuth2 身份验证提供程序\n\t\tnew OAuth2QQWebsiteAuthenticationProvider(http);\n\t\t// 微信小程序 OAuth2 身份验证提供程序\n\t\tnew OAuth2WeChatMiniProgramAuthenticationProvider(http);\n\t\t// 微信公众号 OAuth2 身份验证提供程序\n\t\tnew OAuth2WeChatOffiaccountAuthenticationProvider(http);\n\t\t// 微信开放平台 网站应用 OAuth2 身份验证提供程序\n\t\tnew OAuth2WeChatOplatformWebsiteAuthenticationProvider(http);\n\t\t// 企业微信扫码登录 OAuth2 身份验证提供程序\n\t\tnew OAuth2WeChatWorkWebsiteAuthenticationProvider(http);\n\t\t// 微博 网站应用 OAuth2 身份验证提供程序\n\t\tnew OAuth2WeiBoWebsiteAuthenticationProvider(http);\n\n\t\tauthorizationServerConfigurer.tokenRevocationEndpoint(tokenRevocationEndpointCustomizer -> {\n\t\t\t// 自定义撤销授权成功后的处理\n\t\t\ttokenRevocationEndpointCustomizer.revocationResponseHandler(authenticationSuccessHandler);\n\t\t});\n\n\t\tauthorizationServerConfigurer.clientAuthentication(clientAuthenticationCustomizer -> {\n\t\t\tClientSecretAuthenticationProvider clientSecretAuthenticationProvider = new ClientSecretAuthenticationProvider(\n\t\t\t\t\tregisteredClientRepository, authorizationService);\n\t\t\tClientPasswordEncoder passwordEncoder = new ClientPasswordEncoder();\n\t\t\t// 自定义客户密码编辑器\n\t\t\tclientSecretAuthenticationProvider.setPasswordEncoder(passwordEncoder);\n\t\t\tclientAuthenticationCustomizer.authenticationProvider(clientSecretAuthenticationProvider);\n\t\t});\n\n\t\treturn http.build();\n\t}\n\n\t/**\n\t * @see JWKSource 用于签署访问令牌的实例。\n\t */\n\t@Bean\n\tpublic JWKSource<SecurityContext> jwkSource() {\n\t\tRSAKey rsaKey = new RSAKey.Builder(cloudJwkKeyProperties.rsaPublicKey())\n\t\t\t.privateKey(cloudJwkKeyProperties.privateKey())\n\t\t\t.build();\n\t\tJWKSet jwkSet = new JWKSet(rsaKey);\n\t\treturn new ImmutableJWKSet<>(jwkSet);\n\t}\n\n\t@Bean\n\tpublic JwtDecoder jwtDecoder(JWKSource<SecurityContext> jwkSource) {\n\t\treturn OAuth2AuthorizationServerConfiguration.jwtDecoder(jwkSource);\n\t}\n\n\t/**\n\t * {@link AuthorizationServerSettings} 配置 Spring Authorization Server 的实例。\n\t * @see <a href=\n\t * \"https://github.com/spring-projects/spring-authorization-server/commit/c60ae4532f1d745bff6eb793113731aba0493b70\">Rename\n\t * ProviderSettings</a>\n\t */\n\t@Bean\n\tpublic AuthorizationServerSettings authorizationServerSettings() {\n\t\treturn AuthorizationServerSettings.builder().build();\n\t}\n\n}\n"
    }
  },
}
</script>
<template>

    <code-block :code= code></code-block>
</template>

<style scoped>

</style>